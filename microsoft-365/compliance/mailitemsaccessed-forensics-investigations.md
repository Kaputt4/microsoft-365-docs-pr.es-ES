---
title: Usar auditoría avanzada para investigar cuentas comprometidas
f1.keywords:
- NOCSH
ms.author: markjjo
author: markjjo
manager: laurawi
audience: Admin
ms.topic: article
ms.service: O365-seccomp
localization_priority: Priority
ms.collection:
- M365-security-compliance
search.appverid:
- MOE150
- MET150
ms.assetid: ''
description: Use la acción de auditoría del buzón MailItemsAccessed para realizar investigaciones forenses de cuentas de usuarios comprometidas.
ms.openlocfilehash: 15379a5c24ee222cf097e94d46dc46de0e385820
ms.sourcegitcommit: c1f9a1b2a34146c51c9e33c4119a388b249ce7a9
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 01/14/2021
ms.locfileid: "49868008"
---
# <a name="use-advanced-audit-to-investigate-compromised-accounts"></a><span data-ttu-id="94b32-103">Usar auditoría avanzada para investigar cuentas comprometidas</span><span class="sxs-lookup"><span data-stu-id="94b32-103">Use Advanced Audit to investigate compromised accounts</span></span>

<span data-ttu-id="94b32-104">Una cuenta de usuario comprometida (también denominada *adquisición de cuenta*) es un tipo de ataque en el que un atacante obtiene acceso a una cuenta de usuario y opera como el usuario.</span><span class="sxs-lookup"><span data-stu-id="94b32-104">A compromised user account (also called an *account takeover*) is a type of attack when an attacker gains access to a user account and operates as the user.</span></span> <span data-ttu-id="94b32-105">En ocasiones, estos tipos de ataques provocan más daño de lo que el atacante podría haber planeado.</span><span class="sxs-lookup"><span data-stu-id="94b32-105">These types of attacks sometimes cause more damage than the attacker may have intended.</span></span> <span data-ttu-id="94b32-106">Al investigar cuentas de correo electrónico comprometidas, tiene que asumir que se han comprometido más datos de correo de los que se indican mediante el seguimiento de la presencia real del atacante.</span><span class="sxs-lookup"><span data-stu-id="94b32-106">When investigating compromised email accounts, you have to assume that more mail data was compromised than may be indicated by tracing the attacker's actual presence.</span></span> <span data-ttu-id="94b32-107">Según el tipo de datos de los mensajes de correo electrónico, tiene que asumir que la información confidencial se ha visto comprometida o puede enfrentarse a sanciones, a menos que pueda demostrar que la información confidencial no se ha expuesto.</span><span class="sxs-lookup"><span data-stu-id="94b32-107">Depending on the type of data in email messages, you have to assume that sensitive information was compromised or face regulatory fines unless you can prove that sensitive information wasn't exposed.</span></span> <span data-ttu-id="94b32-108">Por ejemplo, las organizaciones reguladas por HIPAA se enfrentan a multas considerables si hay evidencia de que la información sanitaria del paciente (PHI) se ha expuesto.</span><span class="sxs-lookup"><span data-stu-id="94b32-108">For example, HIPAA-regulated organizations face significant fines if there is evidence that patient health information (PHI) was exposed.</span></span> <span data-ttu-id="94b32-109">En estos casos, es poco probable que los atacantes estén interesados en la PHI, pero las organizaciones deben informar de las vulneraciones de datos, a menos que puedan probar lo contrario.</span><span class="sxs-lookup"><span data-stu-id="94b32-109">In these cases, attackers are unlikely to be interested in PHI, but organizations still must report data breaches unless they can prove otherwise.</span></span>

<span data-ttu-id="94b32-110">Para ayudarle con la investigación de las cuentas de correo electrónico, ahora estamos realizando auditorías de los accesos a los datos por parte de protocolos de correo y clientes con la acción de auditoría del buzón *MailItemsAccessed*.</span><span class="sxs-lookup"><span data-stu-id="94b32-110">To help you with investigating compromise email accounts, we're now auditing accesses of mail data by mail protocols and clients with the *MailItemsAccessed* mailbox auditing action.</span></span> <span data-ttu-id="94b32-111">Esta nueva acción de auditoría ayudará a los investigadores a entender mejor las vulneraciones de datos del correo electrónico y le ayudarán a identificar el alcance de los elementos de correo específicos que se pueden ver comprometidos.</span><span class="sxs-lookup"><span data-stu-id="94b32-111">This new audited action will help investigators better understand email data breaches and help you identify the scope of compromises to specific mail items that may been compromised.</span></span> <span data-ttu-id="94b32-112">El objetivo del uso de esta nueva acción de auditoría son las actividades forenses de defensa para ayudarle a confirmar que no se han comprometido los datos de un elemento de correo determinado.</span><span class="sxs-lookup"><span data-stu-id="94b32-112">The goal of using this new auditing action is forensics defensibility to help assert that a specific piece of mail data was not compromised.</span></span> <span data-ttu-id="94b32-113">Si un atacante ha obtenido acceso a una parte específica del correo, Exchange Online realiza una auditoría del evento incluso aunque no haya ninguna indicación de que el elemento de correo se haya leído realmente.</span><span class="sxs-lookup"><span data-stu-id="94b32-113">If an attacker gained access to a specific piece of mail, Exchange Online audits the event even though there is no indication that the mail item was actually read.</span></span>

## <a name="the-mailitemsaccessed-mailbox-auditing-action"></a><span data-ttu-id="94b32-114">La acción de auditoría del buzón MailItemsAccessed</span><span class="sxs-lookup"><span data-stu-id="94b32-114">The MailItemsAccessed mailbox auditing action</span></span>

<span data-ttu-id="94b32-115">La nueva acción MailItemsAccessed forma parte de la nueva función de [auditoría avanzada](advanced-audit.md).</span><span class="sxs-lookup"><span data-stu-id="94b32-115">The new MailItemsAccessed action is part of the new [Advanced Audit](advanced-audit.md) functionality.</span></span> <span data-ttu-id="94b32-116">Forma parte de las [auditorías del buzón de Exchange](https://docs.microsoft.com/office365/securitycompliance/enable-mailbox-auditing#mailbox-auditing-actions) y está habilitada de forma predeterminada para los usuarios que tienen asignada una licencia de Office 365 o Microsoft 365 E5 o para las organizaciones con una suscripción al complemento de Cumplimiento de Microsoft 365 E5.</span><span class="sxs-lookup"><span data-stu-id="94b32-116">It's part of [Exchange mailbox auditing](https://docs.microsoft.com/office365/securitycompliance/enable-mailbox-auditing#mailbox-auditing-actions) and is enabled by default for users that are assigned an Office 365 or Microsoft 365 E5 license or for organizations with a Microsoft 365 E5 Compliance add-on subscription.</span></span>

<span data-ttu-id="94b32-117">La acción de auditoría del buzón MailItemsAccessed abarca todos los protocolos de correo: POP, IMAP, MAPI, EWS, Exchange ActiveSync y REST.</span><span class="sxs-lookup"><span data-stu-id="94b32-117">The MailItemsAccessed mailbox auditing action covers all mail protocols: POP, IMAP, MAPI, EWS, Exchange ActiveSync, and REST.</span></span> <span data-ttu-id="94b32-118">También cubre los dos tipos de acceso al correo: *sincronización* y *enlace*.</span><span class="sxs-lookup"><span data-stu-id="94b32-118">It also covers both types of accessing mail: *sync* and *bind*.</span></span>

### <a name="auditing-sync-access"></a><span data-ttu-id="94b32-119">Auditoría del acceso de sincronización</span><span class="sxs-lookup"><span data-stu-id="94b32-119">Auditing sync access</span></span>

<span data-ttu-id="94b32-120">Las operaciones de sincronización solo se registran cuando se obtiene acceso a un buzón mediante una versión de escritorio del cliente de Outlook para Windows o Mac.</span><span class="sxs-lookup"><span data-stu-id="94b32-120">Sync operations are only recorded when a mailbox is accessed by a desktop version of the Outlook client for Windows or Mac.</span></span> <span data-ttu-id="94b32-121">Durante la operación de sincronización, estos clientes suelen descargar un amplio conjunto de elementos de correo desde la nube a un equipo local.</span><span class="sxs-lookup"><span data-stu-id="94b32-121">During the sync operation, these clients typically download a large set of mail items from the cloud to a local computer.</span></span> <span data-ttu-id="94b32-122">El volumen de auditoría para las operaciones de sincronización es inmenso.</span><span class="sxs-lookup"><span data-stu-id="94b32-122">The audit volume for sync operations is huge.</span></span> <span data-ttu-id="94b32-123">Por lo tanto, en lugar de generar un registro de auditoría para cada elemento de correo que está sincronizando, solo generamos un evento de auditoría para la carpeta de correo que contiene los elementos que se han sincronizado.</span><span class="sxs-lookup"><span data-stu-id="94b32-123">So, instead of generating an audit record for each mail item that's synched, we just generate an audit event for the mail folder containing items that were synched.</span></span> <span data-ttu-id="94b32-124">Esto presupone que *todos* los elementos de correo de la carpeta sincronizada se han visto comprometidos.</span><span class="sxs-lookup"><span data-stu-id="94b32-124">This makes the assumption that *all* mail items in the synched folder have been compromised.</span></span> <span data-ttu-id="94b32-125">El tipo de acceso se registra en el campo OperationProperties del registro de auditoría.</span><span class="sxs-lookup"><span data-stu-id="94b32-125">The access type is recorded in the OperationProperties field of the audit record.</span></span> 

<span data-ttu-id="94b32-126">Vea el paso 2 de la sección [usar registros de auditoría de MailItemsAccessed para investigaciones forenses](#use-mailitemsaccessed-audit-records-for-forensic-investigations) para ver un ejemplo de cómo mostrar el tipo de acceso de sincronización en un registro de auditoría.</span><span class="sxs-lookup"><span data-stu-id="94b32-126">See step 2 in the [Use MailItemsAccessed audit records for forensic investigations](#use-mailitemsaccessed-audit-records-for-forensic-investigations) section for an example of displaying the sync access type in an audit record.</span></span>

### <a name="auditing-bind-access"></a><span data-ttu-id="94b32-127">Auditoría del acceso de enlace</span><span class="sxs-lookup"><span data-stu-id="94b32-127">Auditing bind access</span></span>

<span data-ttu-id="94b32-128">Una operación de enlace es un acceso individual a un mensaje de correo electrónico.</span><span class="sxs-lookup"><span data-stu-id="94b32-128">A bind operation is an individual access to an email message.</span></span> <span data-ttu-id="94b32-129">Para el acceso de enlace, el InternetMessageId de mensajes individuales se grabará en el registro de auditoría.</span><span class="sxs-lookup"><span data-stu-id="94b32-129">For bind access, the InternetMessageId of individual messages will be recorded in the audit record.</span></span> <span data-ttu-id="94b32-130">La acción de auditoría MailItemsAccessed registra las operaciones de enlace y las agrega en un único registro de auditoría.</span><span class="sxs-lookup"><span data-stu-id="94b32-130">The MailItemsAccessed audit action records bind operations and then aggregates into a single audit record.</span></span> <span data-ttu-id="94b32-131">Todas las operaciones de enlace que tienen lugar dentro de un intervalo de 2 minutos se agregan en un único registro de auditoría en el campo Carpetas de la propiedad AuditData.</span><span class="sxs-lookup"><span data-stu-id="94b32-131">All bind operations that occur within a 2-minute interval are aggregated in a single audit record in the Folders field within the AuditData property.</span></span> <span data-ttu-id="94b32-132">Cada mensaje al que se haya obtenido acceso se identifica por su InternetMessageId.</span><span class="sxs-lookup"><span data-stu-id="94b32-132">Each message that was accessed is identified by its InternetMessageId.</span></span> <span data-ttu-id="94b32-133">El número de operaciones de enlace agregadas al registro se muestra en el campo OperationCount en la propiedad AuditData.</span><span class="sxs-lookup"><span data-stu-id="94b32-133">The number of bind operations that were aggregated in the record is displayed in the OperationCount field in the AuditData property.</span></span>

<span data-ttu-id="94b32-134">Vea el paso 4 de la sección [usar registros de auditoría de MailItemsAccessed para investigaciones forenses](#use-mailitemsaccessed-audit-records-for-forensic-investigations) para ver un ejemplo de cómo mostrar el tipo de acceso de enlace en un registro de auditoría.</span><span class="sxs-lookup"><span data-stu-id="94b32-134">See step 4 in the [Use MailItemsAccessed audit records for forensic investigations](#use-mailitemsaccessed-audit-records-for-forensic-investigations) section for an example of displaying the bind access type in an audit record.</span></span>

### <a name="throttling-of-mailitemsaccessed-audit-records"></a><span data-ttu-id="94b32-135">Limitación de registros de auditoría de MailItemsAccessed</span><span class="sxs-lookup"><span data-stu-id="94b32-135">Throttling of MailItemsAccessed audit records</span></span>

<span data-ttu-id="94b32-136">Si se generan más de 1 000 registros de auditoría de MailItemsAccessed en menos de 24 horas, Exchange Online dejará de generar registros de auditoría para actividad de MailItemsAccessed.</span><span class="sxs-lookup"><span data-stu-id="94b32-136">If more than 1,000 MailItemsAccessed audit records are generated in less than 24 hours, Exchange Online will stop generating auditing records for MailItemsAccessed activity.</span></span> <span data-ttu-id="94b32-137">Cuando un buzón está limitado, la actividad de MailItemsAccessed no se registrará durante 24 horas después de que se haya limitado el buzón.</span><span class="sxs-lookup"><span data-stu-id="94b32-137">When a mailbox is throttled, MailItemsAccessed activity will not be logged for 24 hours after the mailbox was throttled.</span></span> <span data-ttu-id="94b32-138">Si esto ocurre, es posible que se haya puesto en peligro el buzón durante este período.</span><span class="sxs-lookup"><span data-stu-id="94b32-138">If this occurs, there's a potential that mailbox could have been compromised during this period.</span></span> <span data-ttu-id="94b32-139">El registro de la actividad de MailItemsAccessed se reanudará tras un período de 24 horas.</span><span class="sxs-lookup"><span data-stu-id="94b32-139">The recording of MailItemsAccessed activity will be resumed following a 24-hour period.</span></span>  

<span data-ttu-id="94b32-140">Aquí se muestran algunas cosas que debe tener en cuenta sobre la limitación:</span><span class="sxs-lookup"><span data-stu-id="94b32-140">Here's a few things to keep in mind about throttling:</span></span>

- <span data-ttu-id="94b32-141">Menos del 1 % de todos los buzones de Exchange Online están limitados</span><span class="sxs-lookup"><span data-stu-id="94b32-141">Less than 1% of all mailboxes in Exchange Online are throttled</span></span>

- <span data-ttu-id="94b32-142">Cuando un buzón está limitado, los registros de auditoría de actividad de MailItemsAccessed son los únicos para los que no se realiza auditoría.</span><span class="sxs-lookup"><span data-stu-id="94b32-142">When a mailbox is throttling, only audit records for MailItemsAccessed activity are not audited.</span></span> <span data-ttu-id="94b32-143">Otras acciones de auditoría del buzón no se verán afectadas.</span><span class="sxs-lookup"><span data-stu-id="94b32-143">Other mailbox auditing actions aren't affected.</span></span>

- <span data-ttu-id="94b32-144">Los buzones solo se limitan para las operaciones de enlace.</span><span class="sxs-lookup"><span data-stu-id="94b32-144">Mailboxes are throttled only for Bind operations.</span></span> <span data-ttu-id="94b32-145">Los registros de auditoría para las operaciones de sincronización no están limitados.</span><span class="sxs-lookup"><span data-stu-id="94b32-145">Audit records for sync operations are not throttled.</span></span>

- <span data-ttu-id="94b32-146">Si un buzón está limitado, puede suponer que probablemente existe actividad de MailItemsAccessed que no se ha grabado en los registros de auditoría.</span><span class="sxs-lookup"><span data-stu-id="94b32-146">If a mailbox is throttled, you can probably assume there was MailItemsAccessed activity that wasn't recorded in the audit logs.</span></span>

<span data-ttu-id="94b32-147">Vea el paso 1 de la sección [usar registros de auditoría de MailItemsAccessed para investigaciones forenses](#use-mailitemsaccessed-audit-records-for-forensic-investigations) para ver un ejemplo de cómo mostrar la propiedad IsThrottled en un registro de auditoría.</span><span class="sxs-lookup"><span data-stu-id="94b32-147">See step 1 in the [Use MailItemsAccessed audit records for forensic investigations](#use-mailitemsaccessed-audit-records-for-forensic-investigations) section for an example of displaying the IsThrottled property in an audit record.</span></span>

## <a name="use-mailitemsaccessed-audit-records-for-forensic-investigations"></a><span data-ttu-id="94b32-148">Usar registros de auditoría de MailItemsAccessed para investigaciones forenses</span><span class="sxs-lookup"><span data-stu-id="94b32-148">Use MailItemsAccessed audit records for forensic investigations</span></span>

<span data-ttu-id="94b32-149">La auditoría del buzón genera registros de auditoría para obtener acceso a los mensajes de correo electrónico para que pueda asegurarse de que los mensajes de correo electrónico no se han visto comprometidos.</span><span class="sxs-lookup"><span data-stu-id="94b32-149">Mailbox auditing generates audit records for access to email messages so that you can be confident that email messages haven't been compromised.</span></span> <span data-ttu-id="94b32-150">Por este motivo, en los casos en los que no se está seguro de que se haya tenido acceso a ciertos datos, damos por sentado que ha sido así, registrando toda la actividad de acceso al correo.</span><span class="sxs-lookup"><span data-stu-id="94b32-150">For this reason, in circumstances where we're not certain that some data has been accessed, we assume that it has by recording all mail access activity.</span></span>

<span data-ttu-id="94b32-151">El uso de registros de auditoría de MailItemsAccessed para propósitos forenses suele realizarse después de que se haya resuelto la violación de datos y se haya eliminado el atacante.</span><span class="sxs-lookup"><span data-stu-id="94b32-151">Using MailItemsAccessed audit records for forensics purposes is typically performed after a data breach has been resolved and the attacker has been evicted.</span></span> <span data-ttu-id="94b32-152">Para comenzar la investigación, debe identificar el conjunto de buzones que se han visto comprometidos y determinar el período de tiempo en el que el atacante ha tenido acceso a los buzones de su organización.</span><span class="sxs-lookup"><span data-stu-id="94b32-152">To begin your investigation, you should identify the set of mailboxes that they have been compromised and determine the time frame when attacker had access to mailboxes in your organization.</span></span> <span data-ttu-id="94b32-153">Después, puede usar los cmdlets **Search-UnifiedAuditLog** o **Search-MailboxAuditLog** en el [PowerShell de Exchange Online](https://docs.microsoft.com/powershell/exchange/connect-to-exchange-online-powershell) para buscar registros de auditoría que correspondan a la violación de datos.</span><span class="sxs-lookup"><span data-stu-id="94b32-153">Then, you can use the **Search-UnifiedAuditLog** or **Search-MailboxAuditLog** cmdlets in [Exchange Online PowerShell](https://docs.microsoft.com/powershell/exchange/connect-to-exchange-online-powershell) to search audit records that correspond to the data breach.</span></span> 

<span data-ttu-id="94b32-154">Puede ejecutar uno de los siguientes comandos para buscar registros de auditoría de MailItemsAccessed:</span><span class="sxs-lookup"><span data-stu-id="94b32-154">You can run one of the following commands to search for MailItemsAccessed audit records:</span></span>

<span data-ttu-id="94b32-155">**Registro de auditoría unificado**</span><span class="sxs-lookup"><span data-stu-id="94b32-155">**Unified audit log**</span></span>

```powershell
Search-UnifiedAuditLog -StartDate 01/06/2020 -EndDate 01/20/2020 -UserIds <user1,user2> -Operations MailItemsAccessed -ResultSize 1000
```

<span data-ttu-id="94b32-156">**Registro de auditoría de buzones de correo**</span><span class="sxs-lookup"><span data-stu-id="94b32-156">**Mailbox audit log**</span></span>

```powershell
Search-MailboxAuditLog -Identity <user> -StartDate 01/06/2020 -EndDate 01/20/2020 -Operations MailItemsAccessed -ResultSize 1000 -ShowDetails
```

> [!TIP]
> <span data-ttu-id="94b32-157">Una de las principales diferencias entre estos dos cmdlets es que puede usar el cmdlet **Search-UnifiedAuditLog** para buscar registros de auditoría de la actividad realizada por uno o más usuarios.</span><span class="sxs-lookup"><span data-stu-id="94b32-157">One primary difference between these two cmdlets in that you can use the **Search-UnifiedAuditLog** cmdlet to search for audit records for activity performed by one or more users.</span></span> <span data-ttu-id="94b32-158">El motivo es que *UserIds* es un parámetro de varios valores.</span><span class="sxs-lookup"><span data-stu-id="94b32-158">That's because *UserIds* is a multi-value parameter.</span></span> <span data-ttu-id="94b32-159">El cmdlet **Search-MailboxAuditLog** busca el registro de auditoría del buzón de un único usuario.</span><span class="sxs-lookup"><span data-stu-id="94b32-159">The **Search-MailboxAuditLog** cmdlet searches the mailbox audit log for a single user.</span></span>

<span data-ttu-id="94b32-160">Estos son los pasos para usar los registros de auditoría de MailItemsAccessed para investigar un ataque a un usuario comprometido.</span><span class="sxs-lookup"><span data-stu-id="94b32-160">Here are the steps for using MailItemsAccessed audit records to investigate a compromised user attack.</span></span> <span data-ttu-id="94b32-161">Cada paso muestra la sintaxis de comando para los cmdlets **Search-UnifiedAuditLog** o **Search-MailboxAuditLog**.</span><span class="sxs-lookup"><span data-stu-id="94b32-161">Each step shows the command syntax for the **Search-UnifiedAuditLog** or **Search-MailboxAuditLog** cmdlets.</span></span>

1. <span data-ttu-id="94b32-162">Compruebe si el buzón se ha limitado.</span><span class="sxs-lookup"><span data-stu-id="94b32-162">Check whether the mailbox has been throttled.</span></span> <span data-ttu-id="94b32-163">Si es así, algunos de los registros de auditoría de buzón no se han registrado.</span><span class="sxs-lookup"><span data-stu-id="94b32-163">If so, this would mean that some mailbox auditing records would not have been logged.</span></span> <span data-ttu-id="94b32-164">En el caso de que los registros de auditoría tengan "IsThrottled" establecido en "true", debe suponer que, durante un período de 24 horas después de que se haya generado el registro, el acceso al buzón no se ha auditado y que todos los datos de correo se han visto comprometidos.</span><span class="sxs-lookup"><span data-stu-id="94b32-164">In the case that any audit records have the "IsThrottled" is "True," you should assume that for a 24-hour period afterwards that record was generated, that any access to the mailbox was not audited and that all mail data has been compromised.</span></span>

   <span data-ttu-id="94b32-165">Para buscar registros de MailItemsAccessed en los que el buzón estaba limitado, ejecute el siguiente comando:</span><span class="sxs-lookup"><span data-stu-id="94b32-165">To search for MailItemsAccessed records where the mailbox was throttled, run the following command:</span></span>

   <span data-ttu-id="94b32-166">**Registro de auditoría unificado**</span><span class="sxs-lookup"><span data-stu-id="94b32-166">**Unified audit log**</span></span>
 
   ```powershell
   Search-UnifiedAuditLog -StartDate 01/06/2020 -EndDate 01/20/2020 -UserIds <user1,user2> -Operations MailItemsAccessed -ResultSize 1000 | Where {$_.AuditData -like '*"IsThrottled","Value":"True"*'} | FL
   ```

   <span data-ttu-id="94b32-167">**Registro de auditoría de buzones de correo**</span><span class="sxs-lookup"><span data-stu-id="94b32-167">**Mailbox audit log**</span></span>

   ```powershell
   Search-MailboxAuditLog -StartDate 01/06/2020 -EndDate 01/20/2020 -Identity <user> -Operations MailItemsAccessed -ResultSize 10000 -ShowDetails | Where {$_.OperationProperties -like "*IsThrottled:True*"} | FL
   ```

2. <span data-ttu-id="94b32-168">Busque actividades de sincronización.</span><span class="sxs-lookup"><span data-stu-id="94b32-168">Check for sync activities.</span></span> <span data-ttu-id="94b32-169">Si un atacante usa un cliente de correo electrónico para descargar los mensajes de un buzón, puede desconectar el equipo de Internet y tener acceso a los mensajes de forma local sin interactuar con el servidor.</span><span class="sxs-lookup"><span data-stu-id="94b32-169">If an attacker uses an email client to downloaded messages in a mailbox, they can disconnect the computer from the Internet and access the messages locally without interacting with the server.</span></span> <span data-ttu-id="94b32-170">Esto quiere decir que la auditoría de buzón no podría auditar estas actividades.</span><span class="sxs-lookup"><span data-stu-id="94b32-170">This means that mailbox auditing would not be able to audit these activities.</span></span>

   <span data-ttu-id="94b32-171">Para buscar registros de MailItemsAccessed en que se accedió a los elementos de correo con una operación de sincronización, ejecute el siguiente comando:</span><span class="sxs-lookup"><span data-stu-id="94b32-171">To search for MailItemsAccessed records where the mail items were accessed by a sync operation, run the following command:</span></span>

   <span data-ttu-id="94b32-172">**Registro de auditoría unificado**</span><span class="sxs-lookup"><span data-stu-id="94b32-172">**Unified audit log**</span></span>

   ```powershell
   Search-UnifiedAuditLog -StartDate 01/06/2020 -EndDate 02/20/2020 -UserIds <user1,user2> -Operations MailItemsAccessed -ResultSize 1000 | Where {$_.AuditData -like '*"MailAccessType","Value":"Sync"*'} | FL
   ```

   <span data-ttu-id="94b32-173">**Registro de auditoría de buzones de correo**</span><span class="sxs-lookup"><span data-stu-id="94b32-173">**Mailbox audit log**</span></span>

   ```powershell
   Search-MailboxAuditLog -StartDate 01/06/2020 -EndDate 01/20/2020 -Identity <user> -Operations MailItemsAccessed -ResultSize 10000 -ShowDetails | Where {$_.OperationProperties -like "*MailAccessType:Sync*"} | FL
   ```

3. <span data-ttu-id="94b32-174">Compruebe las actividades de sincronización para determinar si alguna de ellas se ha producido en el mismo contexto que la usada por el acceso del atacante al buzón.</span><span class="sxs-lookup"><span data-stu-id="94b32-174">Check sync activities to determine in any of them have occurred in the same context as the one used by the attacker access the mailbox.</span></span> <span data-ttu-id="94b32-175">El contexto se identifica y se diferencia por la dirección IP del equipo cliente usado para tener acceso al buzón y al protocolo de correo.</span><span class="sxs-lookup"><span data-stu-id="94b32-175">Context is identified and differentiated by the IP address of the client computer used to access the mailbox and the mail protocol.</span></span> <span data-ttu-id="94b32-176">Para obtener más información, vea la sección [identificar los contextos de acceso de diferentes registros de auditoría](#identifying-the-access-contexts-of-different-audit-records).</span><span class="sxs-lookup"><span data-stu-id="94b32-176">For more information, see the [Identifying the access contexts of different audit records](#identifying-the-access-contexts-of-different-audit-records) section.</span></span>

   <span data-ttu-id="94b32-177">Use las propiedades que se enumeran a continuación para investigar.</span><span class="sxs-lookup"><span data-stu-id="94b32-177">Use the properties listed below to investigate.</span></span> <span data-ttu-id="94b32-178">Estas propiedades se encuentran en las propiedades OperationProperties o AuditData.</span><span class="sxs-lookup"><span data-stu-id="94b32-178">These properties are located in the AuditData or OperationProperties property.</span></span> <span data-ttu-id="94b32-179">Si cualquiera de las sincronizaciones tiene lugar en el mismo contexto que la actividad del atacante, debe asumir que el atacante ha sincronizado todos los elementos de correo con su cliente, lo que significa que es posible que se haya visto comprometido todo el buzón.</span><span class="sxs-lookup"><span data-stu-id="94b32-179">If any of the syncs occur in the same context as the attacker activity, assume the attacker has synced all mail items to their client, which means the entire mailbox has probably been compromised.</span></span>

   |<span data-ttu-id="94b32-180">Propiedad</span><span class="sxs-lookup"><span data-stu-id="94b32-180">Property</span></span>         | <span data-ttu-id="94b32-181">Description</span><span class="sxs-lookup"><span data-stu-id="94b32-181">Description</span></span> |
   |:---------------- | :----------|
   |<span data-ttu-id="94b32-182">ClientInfoString</span><span class="sxs-lookup"><span data-stu-id="94b32-182">ClientInfoString</span></span> | <span data-ttu-id="94b32-183">Describe el protocolo, cliente (incluye la versión).</span><span class="sxs-lookup"><span data-stu-id="94b32-183">Describes protocol, client (includes version)</span></span>|
   |<span data-ttu-id="94b32-184">ClientIPAddress</span><span class="sxs-lookup"><span data-stu-id="94b32-184">ClientIPAddress</span></span>  | <span data-ttu-id="94b32-185">Dirección IP del equipo cliente.</span><span class="sxs-lookup"><span data-stu-id="94b32-185">IP address of the client machine.</span></span>|
   |<span data-ttu-id="94b32-186">SessionId</span><span class="sxs-lookup"><span data-stu-id="94b32-186">SessionId</span></span>        | <span data-ttu-id="94b32-187">El ID. de la sesión le ayuda a diferenciar las acciones de un atacante frente a las actividades cotidianas del usuario en la misma cuenta (en el caso de una cuenta comprometida)</span><span class="sxs-lookup"><span data-stu-id="94b32-187">Session ID helps to differentiate attacker actions vs day-to-day user activities on the same account (in the case of a compromised account)</span></span>|
   |<span data-ttu-id="94b32-188">UserId</span><span class="sxs-lookup"><span data-stu-id="94b32-188">UserId</span></span>           | <span data-ttu-id="94b32-189">UPN del usuario que lee el mensaje.</span><span class="sxs-lookup"><span data-stu-id="94b32-189">UPN of the user reading the message.</span></span>|
   |||

4. <span data-ttu-id="94b32-190">Busque actividades de enlace.</span><span class="sxs-lookup"><span data-stu-id="94b32-190">Check for bind activities.</span></span> <span data-ttu-id="94b32-191">Después de seguir los pasos 2 y 3, puede estar seguro de que todos los demás accesos del atacante a los mensajes de correo electrónico se capturarán en los registros de auditoría de MailItemsAccessed que tengan una propiedad MailAccessType con el valor de "bind".</span><span class="sxs-lookup"><span data-stu-id="94b32-191">After performing steps 2 and step 3, you can be confident that all other access to email messages by the attacker will be captured in the MailItemsAccessed audit records that have a MailAccessType property with a value of "Bind".</span></span>

   <span data-ttu-id="94b32-192">Para buscar registros de MailItemsAccessed en que se accedió a los elementos de correo con una operación de enlace, ejecute el siguiente comando:</span><span class="sxs-lookup"><span data-stu-id="94b32-192">To search for MailItemsAccessed records where the mail items were accessed by a Bind operation, run the following command.</span></span>

   <span data-ttu-id="94b32-193">**Registro de auditoría unificado**</span><span class="sxs-lookup"><span data-stu-id="94b32-193">**Unified audit log**</span></span>

   ```powershell
   Search-UnifiedAuditLog -StartDate 01/06/2020 -EndDate 01/20/2020 -UserIds <user1,user2> -Operations MailItemsAccessed -ResultSize 1000 | Where {$_.AuditData -like '*"MailAccessType","Value":"Bind"*'} | FL
   ```
 
   <span data-ttu-id="94b32-194">**Registro de auditoría de buzones de correo**</span><span class="sxs-lookup"><span data-stu-id="94b32-194">**Mailbox audit log**</span></span>
   
   ```powershell
   Search-MailboxAuditLog -StartDate 01/06/2020 -EndDate 01/20/2020 -Identity <user> -Operations MailItemsAccessed -ResultSize 10000 -ShowDetails | Where {$_.OperationProperties -like "*MailAccessType:Bind*"} | FL
   ```

   <span data-ttu-id="94b32-195">Los mensajes de correo electrónico a los que se ha accedido se identifican por su ID. de mensaje de Internet. También puede comprobar si los registros de auditoría tienen el mismo contexto que los de la otra actividad del atacante.</span><span class="sxs-lookup"><span data-stu-id="94b32-195">Email messages that were accessed are identified by their internet message Id. You can also check to see if any audit records have the same context as the ones for other attacker activity.</span></span> <span data-ttu-id="94b32-196">Para obtener más información, vea la sección [identificar los contextos de acceso de diferentes registros de auditoría](#identifying-the-access-contexts-of-different-audit-records).</span><span class="sxs-lookup"><span data-stu-id="94b32-196">For more information, see the [Identifying the access contexts of different audit records](#identifying-the-access-contexts-of-different-audit-records) section.</span></span>
 
   <span data-ttu-id="94b32-197">Puede usar los datos de auditoría para las operaciones de enlace de dos maneras diferentes:</span><span class="sxs-lookup"><span data-stu-id="94b32-197">You can use the audit data for bind operations in two different ways:</span></span>

     - <span data-ttu-id="94b32-198">Acceda o recopile todos los mensajes de correo electrónico a los que el atacante accedió mediante el InternetMessageId para buscarlos y comprobar si alguno de estos mensajes contiene información confidencial.</span><span class="sxs-lookup"><span data-stu-id="94b32-198">Access or collect all email messages the attacker accessed by using the InternetMessageId to find them and then checking to see if any of those messages contains sensitive information.</span></span>

     - <span data-ttu-id="94b32-199">Use el InternetMessageId para buscar registros de auditoría relacionados con un conjunto de mensajes de correo potencialmente confidenciales.</span><span class="sxs-lookup"><span data-stu-id="94b32-199">Use the InternetMessageId to search audit records related to a set of potentially sensitive email messages.</span></span> <span data-ttu-id="94b32-200">Esto es útil si solo le preocupa un pequeño número de mensajes.</span><span class="sxs-lookup"><span data-stu-id="94b32-200">This is useful if you're concerned only about a small number of messages.</span></span>

## <a name="filtering-of-duplicate-audit-records"></a><span data-ttu-id="94b32-201">Filtrar registros de auditoría duplicados</span><span class="sxs-lookup"><span data-stu-id="94b32-201">Filtering of duplicate audit records</span></span>

<span data-ttu-id="94b32-202">Los registros de auditoría duplicados para las mismas operaciones de enlace que tienen lugar dentro de un margen de una hora se filtran para quitar ruido de auditoría.</span><span class="sxs-lookup"><span data-stu-id="94b32-202">Duplicate audit records for the same bind operations that occur within an hour of each other are filtered out to remove auditing noise.</span></span> <span data-ttu-id="94b32-203">Las operaciones de sincronización también se filtran en intervalos de una hora.</span><span class="sxs-lookup"><span data-stu-id="94b32-203">Sync operations are also filtered out at one-hour intervals.</span></span> <span data-ttu-id="94b32-204">La excepción a este proceso de desduplicación se produce si, para el mismo InternetMessageId, cualquiera de las propiedades que se describen en la tabla siguiente es diferente.</span><span class="sxs-lookup"><span data-stu-id="94b32-204">The exception to this de-duplication process occurs if, for the same InternetMessageId, any of the properties described in the following table are different.</span></span> <span data-ttu-id="94b32-205">Si una de estas propiedades es diferente en una operación duplicada, se generará un nuevo registro de auditoría.</span><span class="sxs-lookup"><span data-stu-id="94b32-205">If one of these properties is different in a duplicate operation, a new audit record is generated.</span></span> <span data-ttu-id="94b32-206">Este proceso se describe con más detalle en la sección siguiente.</span><span class="sxs-lookup"><span data-stu-id="94b32-206">This process is described in more detail in the next section.</span></span>

| <span data-ttu-id="94b32-207">Propiedad</span><span class="sxs-lookup"><span data-stu-id="94b32-207">Property</span></span>| <span data-ttu-id="94b32-208">Description</span><span class="sxs-lookup"><span data-stu-id="94b32-208">Description</span></span>|
|:--------|:---------|
|<span data-ttu-id="94b32-209">ClientIPAddress</span><span class="sxs-lookup"><span data-stu-id="94b32-209">ClientIPAddress</span></span> | <span data-ttu-id="94b32-210">Dirección IP del equipo del cliente.</span><span class="sxs-lookup"><span data-stu-id="94b32-210">IP address of the client computer.</span></span>|
|<span data-ttu-id="94b32-211">ClientInfoString</span><span class="sxs-lookup"><span data-stu-id="94b32-211">ClientInfoString</span></span>| <span data-ttu-id="94b32-212">El protocolo de cliente, cliente usado para tener acceso al buzón.</span><span class="sxs-lookup"><span data-stu-id="94b32-212">The client protocol, client used to access the mailbox.</span></span>| 
|<span data-ttu-id="94b32-213">ParentFolder</span><span class="sxs-lookup"><span data-stu-id="94b32-213">ParentFolder</span></span>    | <span data-ttu-id="94b32-214">La ruta de acceso completa a la carpeta del elemento de correo al que se obtuvo acceso.</span><span class="sxs-lookup"><span data-stu-id="94b32-214">The full folder path of the mail item that was accessed.</span></span> |
|<span data-ttu-id="94b32-215">Logon_type</span><span class="sxs-lookup"><span data-stu-id="94b32-215">Logon_type</span></span>      | <span data-ttu-id="94b32-216">Tipo de inicio de sesión del usuario que realizó la acción.</span><span class="sxs-lookup"><span data-stu-id="94b32-216">The logon type of the user who performed the action.</span></span> <span data-ttu-id="94b32-217">Los tipos de inicio de sesión (y el valor de enumeración correspondiente) son propietario (0), administrador (1) y delegado (2).</span><span class="sxs-lookup"><span data-stu-id="94b32-217">The logon types (and their corresponding Enum value) are Owner (0), Admin (1), or Delegate (2).</span></span>|
|<span data-ttu-id="94b32-218">MailAccessType</span><span class="sxs-lookup"><span data-stu-id="94b32-218">MailAccessType</span></span>  | <span data-ttu-id="94b32-219">Si el acceso es una operación de enlace o sincronización.</span><span class="sxs-lookup"><span data-stu-id="94b32-219">Whether the access is a bind or a sync operation.</span></span>|
|<span data-ttu-id="94b32-220">MailboxUPN</span><span class="sxs-lookup"><span data-stu-id="94b32-220">MailboxUPN</span></span>      | <span data-ttu-id="94b32-221">El UPN del buzón en que se encuentra el correo que se está leyendo.</span><span class="sxs-lookup"><span data-stu-id="94b32-221">The UPN of the mailbox where the message being read is located.</span></span>|
|<span data-ttu-id="94b32-222">User</span><span class="sxs-lookup"><span data-stu-id="94b32-222">User</span></span>            | <span data-ttu-id="94b32-223">UPN del usuario que lee el mensaje.</span><span class="sxs-lookup"><span data-stu-id="94b32-223">The UPN of the user reading the message.</span></span>|
|<span data-ttu-id="94b32-224">SessionId</span><span class="sxs-lookup"><span data-stu-id="94b32-224">SessionId</span></span>       | <span data-ttu-id="94b32-225">El ID. de la sesión le ayuda a diferenciar las acciones de un atacante y las actividades cotidianas de un usuario en el mismo buzón (en caso de que una cuenta sea comprometida). Para obtener más información sobre las sesiones, vea [Contextualización de la actividad del atacante en sesiones de Exchange Online](https://techcommunity.microsoft.com/t5/exchange-team-blog/contextualizing-attacker-activity-within-sessions-in-exchange/ba-p/608801).</span><span class="sxs-lookup"><span data-stu-id="94b32-225">The Session Id helps to differentiate attacker actions and day-to-day user activities in the same mailbox (in the case of account compromise) For more information about sessions, see [Contextualizing attacker activity within sessions in Exchange Online](https://techcommunity.microsoft.com/t5/exchange-team-blog/contextualizing-attacker-activity-within-sessions-in-exchange/ba-p/608801).</span></span>|
||||

## <a name="identifying-the-access-contexts-of-different-audit-records"></a><span data-ttu-id="94b32-226">Identificar los contextos de acceso de diferentes registros de auditoría</span><span class="sxs-lookup"><span data-stu-id="94b32-226">Identifying the access contexts of different audit records</span></span>

<span data-ttu-id="94b32-227">Es común que un atacante pueda obtener acceso a un buzón al mismo tiempo que el propietario del buzón obtiene acceso a él.</span><span class="sxs-lookup"><span data-stu-id="94b32-227">It's common that an attacker may access a mailbox at the same time the mailbox owner is accessing it.</span></span> <span data-ttu-id="94b32-228">Para diferenciar el acceso del atacante y el del propietario del buzón, hay propiedades de registro de auditoría que definen el contexto del acceso.</span><span class="sxs-lookup"><span data-stu-id="94b32-228">To differentiate between access by the attacker and the mailbox owner, there are audit record properties that define the context of the access.</span></span> <span data-ttu-id="94b32-229">Como se ha explicado anteriormente, cuando los valores de estas propiedades son diferentes, incluso si la actividad tiene lugar en el intervalo de agregación, se generan registros de auditoría independientes.</span><span class="sxs-lookup"><span data-stu-id="94b32-229">As previously explained, when the values for these properties are different, even when the activity occurs within the aggregation interval, separate audit records are generated.</span></span> <span data-ttu-id="94b32-230">En el ejemplo siguiente, hay tres registros de auditoría diferentes.</span><span class="sxs-lookup"><span data-stu-id="94b32-230">In the following example, there are three different audit records.</span></span> <span data-ttu-id="94b32-231">Cada uno se diferencia por las propiedades de Id. de sesión y ClientIPAddress.</span><span class="sxs-lookup"><span data-stu-id="94b32-231">Each one is differentiated by the Session Id and ClientIPAddress properties.</span></span> <span data-ttu-id="94b32-232">También se identifican los mensajes a los que se ha accedido.</span><span class="sxs-lookup"><span data-stu-id="94b32-232">The messages that were accessed are also identified.</span></span>

|<span data-ttu-id="94b32-233">Registro de auditoría 1</span><span class="sxs-lookup"><span data-stu-id="94b32-233">Audit record 1</span></span>  |<span data-ttu-id="94b32-234">Registro de auditoría 2</span><span class="sxs-lookup"><span data-stu-id="94b32-234">Audit record 2</span></span>  |<span data-ttu-id="94b32-235">Registro de auditoría 3</span><span class="sxs-lookup"><span data-stu-id="94b32-235">Audit record 3</span></span>|
|---------|---------|---------|
|<span data-ttu-id="94b32-236">ClientIPAddress **1**</span><span class="sxs-lookup"><span data-stu-id="94b32-236">ClientIPAddress **1**</span></span><br/><span data-ttu-id="94b32-237">SessionId **2**</span><span class="sxs-lookup"><span data-stu-id="94b32-237">SessionId **2**</span></span>|<span data-ttu-id="94b32-238">ClientIPAddress **2**</span><span class="sxs-lookup"><span data-stu-id="94b32-238">ClientIPAddress **2**</span></span><br/><span data-ttu-id="94b32-239">SessionId **2**</span><span class="sxs-lookup"><span data-stu-id="94b32-239">SessionId **2**</span></span>|<span data-ttu-id="94b32-240">ClientIPAddress **1**</span><span class="sxs-lookup"><span data-stu-id="94b32-240">ClientIPAddress **1**</span></span><br/><span data-ttu-id="94b32-241">SessionId **3**</span><span class="sxs-lookup"><span data-stu-id="94b32-241">SessionId **3**</span></span>|
|<span data-ttu-id="94b32-242">InternetMessageId **A**</span><span class="sxs-lookup"><span data-stu-id="94b32-242">InternetMessageId **A**</span></span><br/><span data-ttu-id="94b32-243">InternetMessageId **D**</span><span class="sxs-lookup"><span data-stu-id="94b32-243">InternetMessageId **D**</span></span><br/><span data-ttu-id="94b32-244">InternetMessageId **E**</span><span class="sxs-lookup"><span data-stu-id="94b32-244">InternetMessageId **E**</span></span><br/><span data-ttu-id="94b32-245">InternetMessageId **F**</span><span class="sxs-lookup"><span data-stu-id="94b32-245">InternetMessageId **F**</span></span><br/>|<span data-ttu-id="94b32-246">InternetMessageId **A**</span><span class="sxs-lookup"><span data-stu-id="94b32-246">InternetMessageId **A**</span></span><br/><span data-ttu-id="94b32-247">InternetMessageId **C**</span><span class="sxs-lookup"><span data-stu-id="94b32-247">InternetMessageId **C**</span></span>|<span data-ttu-id="94b32-248">InternetMessageId **B**</span><span class="sxs-lookup"><span data-stu-id="94b32-248">InternetMessageId **B**</span></span> |
||||

<span data-ttu-id="94b32-249">Si alguna de las propiedades que aparecen en la tabla de la [sección anterior](#filtering-of-duplicate-audit-records) es diferente, se generará un registro de auditoría independiente para realizar un seguimiento del nuevo contexto.</span><span class="sxs-lookup"><span data-stu-id="94b32-249">If any of the properties listed in the table in the [previous section](#filtering-of-duplicate-audit-records) are different, a separate audit record is generated to track the new context.</span></span> <span data-ttu-id="94b32-250">Los accesos se ordenarán en registros de auditoría separados en función del contexto en el que se haya producido la actividad.</span><span class="sxs-lookup"><span data-stu-id="94b32-250">Accesses will be sorted into the separate audit records depending on the context in which the activity took place.</span></span>

<span data-ttu-id="94b32-251">Por ejemplo, en los registros de auditoría que se muestran en la siguiente captura de pantalla, aunque estamos accediendo al correo de EWSEditor y a OWA de forma simultánea, la actividad de acceso se intercala en diferentes registros de auditoría dependiendo del contexto en el que se haya producido el acceso.</span><span class="sxs-lookup"><span data-stu-id="94b32-251">For example, in audit records shown in the following screenshot, though we are accessing mail from EWSEditor and OWA simultaneously, the access activity is collated in different audit records depending on the context in which the access took place.</span></span> <span data-ttu-id="94b32-252">En este caso, el contexto se define con valores diferentes para la propiedad ClientInfoString.</span><span class="sxs-lookup"><span data-stu-id="94b32-252">In this case, the context is defined by different values for the ClientInfoString property.</span></span>

![Registros de auditoría diferentes en función del contexto](../media/MailItemsAccessed4.png)

<span data-ttu-id="94b32-254">Sintaxis para el comando del recorte de pantalla antarior:</span><span class="sxs-lookup"><span data-stu-id="94b32-254">Here is the syntax for the command shown in the previous screenshot:</span></span>

```powershell
Search-MailboxAuditLog -Identity admin -ShowDetails -Operations MailItemsAccessed -ResultSize 2000 | Select LastAccessed,Operation,AuditOperationsCountInAggregatedRecord,ClientInfoString
``` 
